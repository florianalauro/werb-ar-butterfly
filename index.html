<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>6Farfalle AR - Tunnel</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <a-scene renderer="colorManagement: true;" xr-mode-ui="enabled: true" webxr="optionalFeatures: hit-test;">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1;"></a-entity>
      <a-entity light="type: directional; intensity: 0.5; position: 1 1 1"></a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const swarm = document.querySelector('#swarm');
      const numButterflies = 50; // Aumentato leggermente per un effetto sciame pi√π denso

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.06 0.06 0.06');

        const resetButterfly = (el) => {
          // X: Le farfalle partono da 6 metri a destra e arrivano a -6 metri a sinistra
          const startX = 6; 
          // Y: Altezza variabile tra 1m e 2.5m (altezza occhi)
          const randomY = Math.random() * 1.5 + 1; 
          // Z: SPOSTAMENTO FRONTALE. Usiamo valori negativi (da -2 a -5 metri davanti all'utente)
          const randomZ = -(Math.random() * 3 + 2); 
          const duration = Math.random() * 4000 + 6000;
          
          el.setAttribute('position', `${startX} ${randomY} ${randomZ}`);
          el.setAttribute('rotation', '0 -90 0'); // Orientate per volare verso sinistra

          el.setAttribute('animation', {
            property: 'position',
            to: `-6 ${randomY} ${randomZ}`,
            dur: duration,
            easing: 'linear',
            loop: false
          });
        };

        butterfly.addEventListener('animationcomplete', () => {
          resetButterfly(butterfly);
        });

        // Partenza scaglionata per creare un flusso continuo
        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 10000);
      }
    </script>
  </body>
</html>
