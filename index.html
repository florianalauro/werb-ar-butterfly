<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <script>
      // COMPONENTE PER CAMBIARE COLORE AL MODELLO GLTF
      AFRAME.registerComponent('butterfly-color', {
        schema: {
          color: { type: 'color', default: '#ce0058' }
        },
        init: function () {
          // Attendiamo che il modello sia caricato
          this.el.addEventListener('model-loaded', () => {
            this.updateColor();
          });
        },
        update: function () {
          this.updateColor();
        },
        updateColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;

          const newColor = new THREE.Color(this.data.color);
          
          mesh.traverse((node) => {
            // Cerchiamo le mesh delle ali (che hanno il materiale "Wings")
            if (node.isMesh && node.material && (node.material.name === 'Wings' || node.name.includes('Object_7') || node.name.includes('Object_9'))) {
              node.material.color.copy(newColor);
            }
          });
        }
      });
    </script>

    <a-scene renderer="colorManagement: true;" xr-mode-ui="enabled: true">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1.5;"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; position: 1 1 1"></a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const swarm = document.querySelector('#swarm');
      const numButterflies = 150;

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.1 0.1 0.1');
        
        // Inizializziamo il componente colore
        butterfly.setAttribute('butterfly-color', 'color: #ce0058');

        const resetButterfly = (el) => {
          const startX = 6; 
          const randomY = Math.random() * 1.5 + 1; 
          const randomZ = -(Math.random() * 3 + 2); 
          const duration = Math.random() * 4000 + 8000;
          
          el.setAttribute('position', `${startX} ${randomY} ${randomZ}`);
          el.setAttribute('rotation', '0 -90 0');

          // ANIMAZIONE POSIZIONE (Volo)
          el.setAttribute('animation__move', {
            property: 'position',
            to: `-6 ${randomY} ${randomZ}`,
            dur: duration,
            easing: 'linear',
            loop: false
          });

          // ANIMAZIONE COLORE (Graduale da Fucsia a Arancio)
          // Usiamo il componente creato sopra
          el.setAttribute('animation__color', {
            property: 'butterfly-color.color',
            from: '#ce0058',
            to: '#fe5000',
            dur: duration, // Sincronizzato con la durata del volo
            easing: 'linear',
            loop: false
          });
        };

        butterfly.addEventListener('animationcomplete__move', () => {
          resetButterfly(butterfly);
        });

        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 10000);
      }
    </script>
  </body>
</html>
