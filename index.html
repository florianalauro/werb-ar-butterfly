<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
      /* Overlay di caricamento e autorizzazione */
      #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); color: white;
        display: flex; flex-direction: column; justify-content: center;
        align-items: center; z-index: 1000; font-family: sans-serif; text-align: center;
      }
      .btn-start {
        background-color: #ce0058; color: white; border: none;
        padding: 18px 40px; font-size: 1.4em; border-radius: 50px;
        cursor: pointer; margin-top: 20px; font-weight: bold;
        box-shadow: 0 4px 15px rgba(206, 0, 88, 0.5);
      }
      .hidden { display: none !important; }
      .instruction-text { margin-top: 15px; font-size: 1em; opacity: 0.8; }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">

    <div id="overlay">
      <h1 style="color: #ce0058; margin-bottom: 0;">BUTTERFLY FLOW</h1>
      <div id="status-msg">
        <p class="instruction-text">Welcome to the Flow</p>
        <button class="btn-start" onclick="startExperience()">START</button>
      </div>
      <div id="calibration-msg" class="hidden">
        <div style="width: 40px; height: 70px; border: 3px solid white; border-radius: 5px; margin: 20px auto; animation: pulse 2s infinite;"></div>
        <p>Keep your phone vertically in front of you</p>
      </div>
    </div>

    <script>
      // Componente Colore Ali (Fucsia -> Arancio)
      AFRAME.registerComponent('butterfly-color', {
        schema: { color: { type: 'color', default: '#ce0058' } },
        init: function () { this.el.addEventListener('model-loaded', () => this.applyColor()); },
        update: function () { this.applyColor(); },
        applyColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;
          const newColor = new THREE.Color(this.data.color);
          mesh.traverse((node) => {
            if (node.isMesh && node.material && node.material.name === 'Wings') {
              node.material.color.copy(newColor);
              node.material.emissive.copy(newColor); 
              node.material.emissiveIntensity = 2;        
            }
          });
        }
      });

      let sensorsActive = false;
      let experienceActivated = false;

      function startExperience() {
        // Richiesta permessi per iOS (Safari)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(response => {
            if (response == 'granted') { proceedToCalibration(); }
          }).catch(console.error);
        } else {
          proceedToCalibration();
        }
      }

      function proceedToCalibration() {
        sensorsActive = true;
        document.getElementById('status-msg').classList.add('hidden');
        document.getElementById('calibration-msg').classList.remove('hidden');
      }
    </script>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="colorManagement: true; exposure: 1.3;" xr-mode-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
      </a-assets>

      <a-camera id="main-camera" look-controls></a-camera>

      <a-entity id="swarm" visible="false"></a-entity>

      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 1 1"></a-entity>
    </a-scene>
    
    <script>
      const swarm = document.querySelector('#swarm');
      const camera = document.querySelector('#main-camera');
      const overlay = document.querySelector('#overlay');

      // Controllo orientamento per attivazione automatica dello sciame
      setInterval(() => {
        if (!sensorsActive || experienceActivated) return;
        
        const rotation = camera.getAttribute('rotation');
        // Se il telefono Ã¨ verticale (pitch tra -25 e 25 gradi)
        if (rotation.x > -25 && rotation.x < 25) {
          experienceActivated = true;
          overlay.classList.add('hidden');
          swarm.setAttribute('visible', 'true');
        }
      }, 200);

      // --- LOGICA SCIAME ---
      const numButterflies = 150;
      const tLength = 20; const tHeight = 7; const tWidth = 7;
      const rows = 12; const cols = 13;
      let grid = [];
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          grid.push({ y: (r / (rows - 1)) * tHeight, z: -((c / (cols - 1)) * tWidth + 5) });
        }
      }
      grid.sort(() => Math.random() - 0.5);

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        const slot = grid[i % grid.length];
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.35 0.35 0.35');
        butterfly.setAttribute('butterfly-color', 'color: #ce0058');

        const resetButterfly = (el) => {
          const moveDuration = Math.random() * 4000 + 8000;
          el.setAttribute('position', `${tLength} ${slot.y} ${slot.z}`);
          el.setAttribute('rotation', '0 -90 0');
          
          el.setAttribute('animation__move', {
            property: 'position', to: `${-tLength} ${slot.y} ${slot.z}`,
            dur: moveDuration, easing: 'linear'
          });

          el.setAttribute('animation__color', {
            property: 'butterfly-color.color', from: '#ce0058', to: '#fe5000',
            dur: moveDuration, easing: 'linear'
          });
        };

        butterfly.addEventListener('animationcomplete__move', () => resetButterfly(butterfly));
        swarm.appendChild(butterfly);
        resetButterfly(butterfly);
      }
    </script>
    
    <style> @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } } </style>
  </body>
</html>
