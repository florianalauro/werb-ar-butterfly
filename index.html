<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <script>
      AFRAME.registerComponent('butterfly-color', {
        schema: { color: { type: 'color', default: '#ce0058' } },
        init: function () {
          this.el.addEventListener('model-loaded', () => { this.applyColor(); });
        },
        update: function () { this.applyColor(); },
        applyColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;
          const newColor = new THREE.Color(this.data.color);
          newColor.convertSRGBToLinear();
          mesh.traverse((node) => {
            if (node.isMesh && node.material && node.material.name === 'Wings') {
              node.material.color.copy(newColor);
              node.material.emissive = newColor; 
              node.material.emissiveIntensity = 10; 
            }
          });
        }
      });
    </script>

    <a-scene renderer="colorManagement: true; exposure: 1.3;" xr-mode-ui="enabled: true">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 1 1"></a-entity>

      <a-entity 
        look-at="[camera]"
        position="18 3.5 -7.5">
        <a-text 
          value="Progroup" 
          align="center" 
          width="20" 
          color="#ffffff"
          negate="false"
          shader="msdf"
          font="https://cdn.aframe.io/fonts/Aileron-Semibold.fnt">
        </a-text>
      </a-entity>
      
      <a-entity 
        look-at="[camera]"
        position="-18 3.5 -7.5">
        <a-text 
          value="Ondulkart" 
          align="center" 
          width="20" 
          color="#ffffff"
          negate="false"
          shader="msdf"
          font="https://cdn.aframe.io/fonts/Aileron-Semibold.fnt">
        </a-text>
      </a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const swarm = document.querySelector('#swarm');
      const numButterflies = 150;
      const tLength = 20; 
      const tHeight = 7;  
      const tWidth = 7;   

      const rows = 12;
      const cols = 13;
      let grid = [];
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          grid.push({
            y: (r / (rows - 1)) * tHeight, 
            z: -((c / (cols - 1)) * tWidth + 4) 
          });
        }
      }
      grid.sort(() => Math.random() - 0.5);

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        const slot = grid[i % grid.length]; 
        
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.4 0.4 0.4');
        butterfly.setAttribute('butterfly-color', 'color: #ce0058');

        const resetButterfly = (el) => {
          const startX = tLength;
          const endX = -(tLength);
          const posY = slot.y;
          const posZ = slot.z;
          const moveDuration = Math.random() * 4000 + 8000;
          const colorDuration = moveDuration * 0.6; 

          el.setAttribute('position', `${startX} ${posY} ${posZ}`);
          el.setAttribute('rotation', '0 -90 0');

          el.setAttribute('animation__move', {
            property: 'position',
            to: `${endX} ${posY} ${posZ}`,
            dur: moveDuration,
            easing: 'linear'
          });

          el.setAttribute('animation__color', {
            property: 'butterfly-color.color',
            from: '#ce0058',
            to: '#fe5000',
            dur: colorDuration,
            easing: 'linear',
            loop: false
          });
        };

        butterfly.addEventListener('animationcomplete__move', () => {
          resetButterfly(butterfly);
        });

        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 10000);
      }
    </script>
  </body>
</html>
