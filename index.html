<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <script>
      // Colori richiesti dall'utente
      const HEX_FUCSIA = "#CE0058";
      const HEX_ARANCIONE = "#FE5000";

      AFRAME.registerComponent('butterfly-logic', {
        init: function () {
          this.wingMaterials = [];
          this.colorStart = new THREE.Color(HEX_FUCSIA);
          this.colorEnd = new THREE.Color(HEX_ARANCIONE);
          
          // Parametri del tunnel
          this.startX = 6; 
          this.endX = -6;
          this.posY = Math.random() * 2 + 1; 
          this.posZ = (Math.random() - 0.5) * 5;
          this.duration = Math.random() * 4000 + 6000;
          
          // Distribuzione istantanea nel tunnel
          this.progress = Math.random();

          this.el.addEventListener('model-loaded', () => {
            const mesh = this.el.getObject3D('mesh');
            mesh.traverse(node => {
              // Identifichiamo le ali (Object_0/1 o materiale Wings)
              if (node.isMesh && (node.name.includes("Object_0") || node.name.includes("Object_1") || (node.material && node.material.name === "Wings"))) {
                
                node.material = node.material.clone();
                
                // Manteniamo la texture ma neutralizziamo il colore base a bianco
                // In questo modo la texture originale non "sporca" il gradiente
                node.material.color.set("#FFFFFF"); 
                
                // Usiamo Emissive per "illuminare" le ali con i tuoi colori HEX
                node.material.emissiveIntensity = 0.8; 
                node.material.needsUpdate = true;
                
                this.wingMaterials.push(node.material);
              }
            });
            this.isReady = true;
          });
        },

        tick: function (time, timeDelta) {
          if (!this.isReady) return;

          this.progress += timeDelta / this.duration;

          if (this.progress > 1) {
            this.progress = 0;
            this.posY = Math.random() * 2 + 1;
            this.posZ = (Math.random() - 0.5) * 5;
          }

          // Aggiorna Posizione (X: 6 -> -6)
          const currentX = this.startX + (this.endX - this.startX) * this.progress;
          this.el.object3D.position.set(currentX, this.posY, this.posZ);
          this.el.object3D.rotation.set(0, -Math.PI / 2, 0); // Ruotate correttamente verso sinistra

          // LOGICA GRADIENTE (0.0 -> 0.25 FUCSIA, 0.25 -> 0.75 GRADIENTE, 0.75 -> 1.0 ARANCIONE)
          let lerpFactor = 0;
          if (this.progress < 0.25) {
            lerpFactor = 0;
          } else if (this.progress > 0.75) {
            lerpFactor = 1;
          } else {
            lerpFactor = (this.progress - 0.25) / 0.5;
          }

          const targetColor = new THREE.Color().copy(this.colorStart).lerp(this.colorEnd, lerpFactor);
          
          // Applica il colore al canale Emissive per farlo brillare sopra la texture
          this.wingMaterials.forEach(mat => {
            mat.emissive.copy(targetColor);
          });
        }
      });
    </script>

    <a-scene renderer="colorManagement: true;" xr-mode-ui="enabled: true" webxr="optionalFeatures: hit-test;">
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm-container"></a-entity>

      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 0.6; position: 1 2 1"></a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const container = document.querySelector('#swarm-container');
      const numButterflies = 60; 

      for (let i = 0; i < numButterflies; i++) {
        let b = document.createElement('a-entity');
        b.setAttribute('gltf-model', '#butterflyModel');
        b.setAttribute('animation-mixer', 'clip: Flying');
        b.setAttribute('butterfly-logic', ''); 
        container.appendChild(b);
      }
    </script>
  </body>
</html>
