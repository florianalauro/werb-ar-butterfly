<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-text-geometry-component@0.5.1/dist/aframe-text-geometry-component.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <script>
      AFRAME.registerComponent('butterfly-color', {
        schema: {
          color: { type: 'color', default: '#ce0058' }
        },
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            this.applyColor();
          });
        },
        update: function () {
          this.applyColor();
        },
        applyColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;

          const newColor = new THREE.Color(this.data.color);

          newColor.convertSRGBToLinear();
          
          mesh.traverse((node) => {
            if (node.isMesh && node.material && node.material.name === 'Wings') {
              node.material.color.copy(newColor);
              node.material.emissive = newColor; 
              node.material.emissiveIntensity = 10; 
              
            }
          });
        }
      });
    </script>

    <a-scene renderer="colorManagement: true; exposure: 1.3;" xr-mode-ui="enabled: true">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
        <a-asset-item id="optimerBold" src="https://rawgit.com/mrdoob/three.js/master/examples/fonts/helvetiker_bold.typeface.json"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 1 1"></a-entity>

      <a-entity text-geometry="value: Progroup; font: #optimerBold; ..."></a-entity>

      <a-entity 
        look-at="[camera]"
        position="18 3.5 -7.5"
        text-geometry="value: Progroup; size: 1.5; height: 0.2;"
        material="color: #ffffff; roughness: 0.1; metalness: 0.2; sphericalEnvMap: #sky;">
      </a-entity>
      
      <a-entity 
        look-at="[camera]"
        position="-18 3.5 -7.5"
        text-geometry="value: Ondulkart; size: 1.5; height: 0.2;"
        material="color: #ffffff; roughness: 0.1; metalness: 0.2; sphericalEnvMap: #sky;">
      </a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const swarm = document.querySelector('#swarm');
      const numButterflies = 150;

      const tLength = 20; // Lunghezza (Asse X)
      const tHeight = 7;  // Altezza (Asse Y)
      const tWidth = 7;   // Larghezza (Asse Z)

      // Logica Anti-Collisione: creazione di una griglia di slot Y/Z (corsie di volo)
      // 12 righe x 13 colonne = 156 slot (sufficienti per 150 farfalle)
      const rows = 12;
      const cols = 13;
      let grid = [];
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          grid.push({
            y: (r / (rows - 1)) * tHeight, 
            // Posizionamento frontale: la larghezza è centrata e spostata davanti alla camera
            z: -((c / (cols - 1)) * tWidth + 4) 
          });
        }
      }
      // Mischia la griglia per una distribuzione più naturale
      grid.sort(() => Math.random() - 0.5);

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        const slot = grid[i % grid.length]; // Assegna uno slot fisso per evitare collisioni
        
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.4 0.4 0.4');
        butterfly.setAttribute('butterfly-color', 'color: #ce0058');

        const resetButterfly = (el) => {
          
          const startX = tLength;
          const endX = -(tLength);
          
          const posY = slot.y;
          const posZ = slot.z;
          const moveDuration = Math.random() * 4000 + 8000;
          const colorDuration = moveDuration * 0.6; 

          el.setAttribute('position', `${startX} ${posY} ${posZ}`);
          el.setAttribute('rotation', '0 -90 0');

          el.setAttribute('animation__move', {
            property: 'position',
            to: `${endX} ${posY} ${posZ}`,
            dur: moveDuration,
            easing: 'linear'
          });

          el.setAttribute('animation__color', {
            property: 'butterfly-color.color',
            from: '#ce0058',
            to: '#fe5000',
            dur: colorDuration,
            easing: 'linear',
            loop: false
          });
        };

        butterfly.addEventListener('animationcomplete__move', () => {
          resetButterfly(butterfly);
        });

        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 10000);
      }
    </script>
  </body>
</html>
