<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
      #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); color: white;
        z-index: 1000; font-family: sans-serif; text-align: center;
      }

      /* Contenitore principale della prima schermata */
      #status-msg {
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Distribuisce Top, Center, Bottom */
        height: 100%;
        padding: 20px 20px 100px 20px; /* Spazio dai bordi*/
        box-sizing: border-box;
      }

      /* Gruppo centrale per THE LINK */
      .middle-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: -5px;
      }

      h1, h2 { color: #fe5000; margin: 0; }
 
      .btn-start {
        background-color: #fe5000; 
        color: white; 
        border: none;
        padding: 18px 40px; 
        font-size: 1.4em; 
        border-radius: 50px;
        cursor: pointer; 
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(254, 80, 0, 0.4);
        align-self: center;
        margin-top: -15px;
      }

      .hidden { display: none !important; }

      /* Schermata calibrazione (mantiene il centro) */
      #calibration-msg {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .icon-frame {
        width: 40px; height: 70px; border: 3px solid #fe5000;
        border-radius: 8px; margin: 20px auto; animation: pulse 2s infinite;
      }
      @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">

    <div id="overlay">
      <div id="status-msg">
        <div class="logo-area">
          <a href="/">
            <img src="Logo Ondulkart_w.svg" alt="Ondulkart" width="260" height="auto">
          </a>
        </div>

        <div class="middle-content">
          <h1 style="font-size: 4.2em; line-height: 1.1;">THE LINK</h1> 
          <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;"><em>Where Technology meets the Soul of Nature</em></p> 
        </div>

        <div class="button-area">
          <button class="btn-start" onclick="startExperience()">START</button>
        </div>
      </div>

      <div id="calibration-msg" class="hidden">
        <div class="icon-frame"></div>
        <h2>POSITION YOUR DEVICE</h2>
        <p>Keep your phone vertically in front of you</p>
      </div>
    </div>

    <script>
      AFRAME.registerComponent('butterfly-color', {
        schema: { color: { type: 'color', default: '#ce0058' } },
        init: function () { this.el.addEventListener('model-loaded', () => this.applyColor()); },
        update: function () { this.applyColor(); },
        applyColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;
          const newColor = new THREE.Color(this.data.color);
          newColor.convertSRGBToLinear();
          mesh.traverse((node) => {
            if (node.isMesh && node.material && node.material.name === 'Wings') {
              node.material.color.copy(newColor);
              node.material.emissive.copy(newColor); 
              node.material.emissiveIntensity = 15;        
            }
          });
        }
      });

      let sensorsActive = false;
      let experienceActivated = false;

      function startExperience() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(response => {
            if (response == 'granted') { proceed(); }
          }).catch(console.error);
        } else { proceed(); }
      }

      function proceed() {
        sensorsActive = true;
        document.getElementById('status-msg').classList.add('hidden');
        document.getElementById('calibration-msg').classList.remove('hidden');
      }
    </script>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="colorManagement: true; exposure: 1.3;" xr-mode-ui="enabled: false">
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
      </a-assets>

      <a-camera id="main-camera" look-controls></a-camera>
      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 1 1"></a-entity>
    </a-scene>
    
    <script>
      const swarm = document.querySelector('#swarm');
      const camera = document.querySelector('#main-camera');
      const overlay = document.querySelector('#overlay');

      setInterval(() => {
        if (!sensorsActive || experienceActivated) return;
        const rotation = camera.getAttribute('rotation');
        if (rotation.x > -20 && rotation.x < 20) {
          experienceActivated = true;
          overlay.classList.add('hidden');
          createSwarm();
        }
      }, 200);

      function createSwarm() {
        const numButterflies = 100;
        const tLength = 20; const tHeight = 6; const tWidth = 8;
        const rows = 10; const cols = 10;
        
        let grid = [];
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            grid.push({ 
              y: (r / (rows - 1)) * tHeight - (tHeight / 2) + 1.5,
              z: -((c / (cols - 1)) * tWidth + 5)
            });
          }
        }
        grid.sort(() => Math.random() - 0.5);

        for (let i = 0; i < numButterflies; i++) {
          let butterfly = document.createElement('a-entity');
          const slot = grid[i % grid.length];
          butterfly.setAttribute('gltf-model', '#butterflyModel');
          butterfly.setAttribute('animation-mixer', 'clip: Flying');
          butterfly.setAttribute('scale', '0.3 0.3 0.3');
          butterfly.setAttribute('butterfly-color', 'color: #ce0058');

          const resetButterfly = (el) => {
            const moveDuration = Math.random() * 4000 + 8000;
            el.setAttribute('position', `${tLength} ${slot.y} ${slot.z}`);
            el.setAttribute('rotation', '0 -90 0');
            el.removeAttribute('animation__move');
            el.removeAttribute('animation__color');
            el.setAttribute('animation__move', {
              property: 'position', to: `${-tLength} ${slot.y} ${slot.z}`,
              dur: moveDuration, easing: 'linear'
            });
            el.setAttribute('animation__color', {
              property: 'butterfly-color.color', from: '#ce0058', to: '#fe5000',
              dur: moveDuration, easing: 'linear'
            });
          };
          butterfly.addEventListener('animationcomplete__move', () => resetButterfly(butterfly));
          setTimeout(() => {
            swarm.appendChild(butterfly);
            resetButterfly(butterfly);
          }, Math.random() * 10000);
        }
      }
    </script>
  </body>
</html>
