<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <style>
      #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); color: white;
        display: flex; flex-direction: column; justify-content: center;
        align-items: center; z-index: 1000; font-family: sans-serif; text-align: center;
      }
      .icon { width: 80px; height: 80px; border: 2px solid white; border-radius: 10px; margin-bottom: 20px; position: relative; }
      .icon::after { content: ''; position: absolute; top: 10px; left: 50%; width: 2px; height: 60px; background: #ce0058; transform: translateX(-50%); }
      .hidden { display: none !important; }
      #status { color: #ce0058; font-weight: bold; margin-top: 10px; }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">

    <div id="overlay">
      <div class="icon"></div>
      <h2>POSITION YOUR DEVICE</h2>
      <p>Keep your phone vertically in front of you<br>to visulize the Flow</p>
      <div id="status">Waiting for the correct position...</div>
    </div>

    <script>
      AFRAME.registerComponent('butterfly-color', {
        schema: {
          color: { type: 'color', default: '#ce0058' }
        },
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            this.applyColor();
          });
        },
        update: function () {
          this.applyColor();
        },
        applyColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;
          const newColor = new THREE.Color(this.data.color);
          newColor.convertSRGBToLinear();
          mesh.traverse((node) => {
            if (node.isMesh && node.material && node.material.name === 'Wings') {
              node.material.color.copy(newColor);
              node.material.emissive.copy(newColor); 
              node.material.emissiveIntensity = 15;        
            }
          });
        }
      });
    </script>

    <a-scene renderer="colorManagement: true; exposure: 1.3;" xr-mode-ui="enabled: true">
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
      </a-assets>
      <a-camera id="main-camera" look-controls></a-camera>
      <a-entity id="swarm" visible="false"></a-entity>
      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 1 1"></a-entity>
    </a-scene>
    
    <script>
      const swarm = document.querySelector('#swarm');
      const overlay = document.querySelector('#overlay');
      const camera = document.querySelector('#main-camera');
      let activated = false;

      // CONTROLLO ORIENTAMENTO
      setInterval(() => {
        if (activated) return;
        const rotation = camera.getAttribute('rotation');
        if (rotation.x > -25 && rotation.x < 25) {
          activateExperience();
        }
      }, 200);

      function activateExperience() {
        activated = true;
        overlay.classList.add('hidden');
        swarm.setAttribute('visible', 'true');
      }

      // --- LOGICA SCIAME ---
      const numButterflies = 150; // Ridotto a 100 per maggiore fluiditÃ  su mobile
      const tLength = 20; 
      const tHeight = 7;  
      const tWidth = 7;

      const rows = 12;
      const cols = 13;
      let grid = [];
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          grid.push({
            y: (r / (rows - 1)) * tHeight, 
            z: -((c / (cols - 1)) * tWidth + 4) 
          });
        }
      }
      grid.sort(() => Math.random() - 0.5);

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        const slot = grid[i % grid.length];

        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.35 0.35 0.35');
        butterfly.setAttribute('butterfly-color', 'color: #ce0058');

        const resetButterfly = (el) => {
          const moveDuration = Math.random() * 4000 + 8000;
          
          el.setAttribute('position', `${tLength} ${slot.y} ${slot.z}`);
          el.setAttribute('rotation', '0 -90 0');

          // MOVIMENTO (Sistemato moveDuration)
          el.setAttribute('animation__move', {
            property: 'position',
            to: `${-tLength} ${slot.y} ${slot.z}`,
            dur: moveDuration,
            easing: 'linear'
          });

          // COLORE (Gradiente corretto)
          el.setAttribute('animation__color', {
            property: 'butterfly-color.color',
            from: '#ce0058',
            to: '#fe5000',
            dur: moveDuration,
            easing: 'linear'
          });
        };

        butterfly.addEventListener('animationcomplete__move', () => {
          resetButterfly(butterfly);
        });

        // Partenza ritardata casuale per creare l'effetto flusso
        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 10000);
      }
    </script>
  </body>
</html>
