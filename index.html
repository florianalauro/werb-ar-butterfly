<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Sciame di Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <a-scene renderer="colorManagement: true;" xr-mode-ui="enabled: true" webxr="optionalFeatures: hit-test;">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity camera look-controls wasd-controls></a-entity>
    </a-scene>

    <script>
      // Script per generare 15 farfalle in posizioni casuali
      const swarm = document.querySelector('#swarm');
      const numButterflies = 20;

      // Colori definiti
      const FUCSIA = "#FF00FF";
      const ARANCIONE = "#FF8800";
      
      for (let i = 0; i < numButterflies; i++) {
          let butterfly = document.createElement('a-entity');
          
          butterfly.setAttribute('gltf-model', '#butterflyModel');
          butterfly.setAttribute('animation-mixer', 'clip: Flying');
          butterfly.setAttribute('scale', '0.04 0.04 0.04');
      
          // Funzione per gestire il movimento e il reset cromatco
          const resetButterfly = (el) => {
              const startX = 5;
              const randomY = Math.random() * 2 + 1;
              const randomZ = (Math.random() - 0.5) * 4;
              const duration = Math.random() * 5000 + 7000; // Un po' più lente per vedere meglio il cambio
              
              el.setAttribute('position', `${startX} ${randomY} ${randomZ}`);
              el.setAttribute('rotation', '0 -90 0');
      
              // Animazione Movimento
              el.setAttribute('animation__move', {
                  property: 'position',
                  to: `-5 ${randomY} ${randomZ}`,
                  dur: duration,
                  easing: 'linear',
                  loop: false
              });
      
              // Applichiamo l'animazione del colore solo se il modello è già pronto
              const mesh = el.getObject3D('mesh');
              if (mesh) {
                  animateWings(mesh, duration);
              }
          };
      
          // Funzione specifica per animare solo le ali
          const animateWings = (root, totalDuration) => {
              root.traverse(node => {
                  // Cerchiamo l'oggetto che si chiama "Wings" o che ha il materiale "Wings"
                  if (node.isMesh && (node.name.includes("Wings") || node.material.name.includes("Wings"))) {
                      
                      // Reset al fucsia iniziale
                      node.material.color.set(FUCSIA);
      
                      // Creiamo un'animazione manuale per il gradiente tra 1/4 e 3/4 del viaggio
                      const startTime = totalDuration * 0.25;
                      const transitionTime = totalDuration * 0.50;
      
                      setTimeout(() => {
                          // Usiamo una transizione fluida CSS-like gestita da A-Frame/Three.js
                          new AFRAME.TWEEN.Tween(node.material.color)
                              .to({r: 1, g: 0.53, b: 0}, transitionTime) // Colore Arancione in RGB (approssimato)
                              .easing(AFRAME.TWEEN.Easing.Linear.None)
                              .start();
                      }, startTime);
                  }
              });
          };
      
          // Evento fondamentale: si attiva solo quando le ali vengono trovate nel file caricato
          butterfly.addEventListener('model-loaded', () => {
              resetButterfly(butterfly);
          });
      
          butterfly.addEventListener('animationcomplete__move', () => {
              resetButterfly(butterfly);
          });
      
          // Partenza scaglionata
          setTimeout(() => {
              swarm.appendChild(butterfly);
          }, Math.random() * 5000);
      }
    </script>
  </body>
</html>
