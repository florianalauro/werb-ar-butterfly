<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <script>
      AFRAME.registerComponent('butterfly-color', {
        schema: {
          color: { type: 'color', default: '#ce0058' }
        },
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            this.updateColor();
          });
        },
        update: function () {
          this.updateColor();
        },
        updateColor: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;

          const newColor = new THREE.Color(this.data.color);
          
          mesh.traverse((node) => {
            if (node.isMesh && node.material) {
              // Applichiamo il colore sia alla base che all'emissivo per la massima brillantezza
              node.material.color.copy(newColor);
              node.material.emissive = newColor; 
              node.material.emissiveIntensity = 0.5; // Regola da 0 a 1 per la "luminosità"
            }
          });
        }
      });
    </script>

    <a-scene renderer="colorManagement: true; exposure: 1.2;" xr-mode-ui="enabled: true">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly_fucsia.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1.2;"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 1 1"></a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const swarm = document.querySelector('#swarm');
      const numButterflies = 150;

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.1 0.1 0.1');
        butterfly.setAttribute('butterfly-color', 'color: #ce0058');

        const resetButterfly = (el) => {
          const startX = 6; 
          const randomY = Math.random() * 1.5 + 1; 
          const randomZ = -(Math.random() * 3 + 2); 
          const moveDuration = Math.random() * 4000 + 8000;
          
          // Il colore cambia in metà tempo rispetto al volo (fucsia -> arancio veloce)
          const colorDuration = moveDuration * 0.5; 

          el.setAttribute('position', `${startX} ${randomY} ${randomZ}`);
          el.setAttribute('rotation', '0 -90 0');

          el.setAttribute('animation__move', {
            property: 'position',
            to: `-6 ${randomY} ${randomZ}`,
            dur: moveDuration,
            easing: 'linear'
          });

          el.setAttribute('animation__color', {
            property: 'butterfly-color.color',
            from: '#ce0058',
            to: '#fe5000',
            dur: colorDuration, // Qui avviene il cambio anticipato
            easing: 'easeInCubic', // Rende il passaggio finale più netto
            loop: false
          });
        };

        butterfly.addEventListener('animationcomplete__move', () => {
          resetButterfly(butterfly);
        });

        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 10000);
      }
    </script>
  </body>
</html>
