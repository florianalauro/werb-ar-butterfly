<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Farfalle AR - Tunnel</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <a-scene renderer="colorManagement: true;" xr-mode-ui="enabled: true" webxr="optionalFeatures: hit-test;">
      
      <a-assets>
        <a-asset-item id="butterflyModel" src="animated_butterfly.glb"></a-asset-item>
      </a-assets>

      <a-entity id="swarm"></a-entity>

      <a-entity light="type: ambient; intensity: 1;"></a-entity>
      <a-entity light="type: directional; intensity: 0.5; position: 1 1 1"></a-entity>

      <a-entity camera look-controls></a-entity>
    </a-scene>

    <script>
      const swarm = document.querySelector('#swarm');
      const numButterflies = 30; // Numero bilanciato per la fluidità

      for (let i = 0; i < numButterflies; i++) {
        let butterfly = document.createElement('a-entity');
        
        butterfly.setAttribute('gltf-model', '#butterflyModel');
        butterfly.setAttribute('animation-mixer', 'clip: Flying');
        butterfly.setAttribute('scale', '0.08 0.08 0.08');

        // Funzione per posizionare e muovere la farfalla nel tunnel
        const resetButterfly = (el) => {
          const startX = 6; // Inizia a destra
          const randomY = Math.random() * 2 + 1; // Altezza tra 1m e 3m
          const randomZ = (Math.random() - 0.5) * 4; // Profondità tunnel
          const duration = Math.random() * 4000 + 6000; // Velocità variabile
          
          el.setAttribute('position', `${startX} ${randomY} ${randomZ}`);
          el.setAttribute('rotation', '0 -90 0'); // Orientata verso sinistra

          // Animazione lineare verso sinistra
          el.setAttribute('animation', {
            property: 'position',
            to: `-6 ${randomY} ${randomZ}`,
            dur: duration,
            easing: 'linear',
            loop: false
          });
        };

        // Quando finisce il percorso, ricomincia da destra
        butterfly.addEventListener('animationcomplete', () => {
          resetButterfly(butterfly);
        });

        // Partenza scaglionata per evitare l'effetto "muro" iniziale
        setTimeout(() => {
          swarm.appendChild(butterfly);
          resetButterfly(butterfly);
        }, Math.random() * 8000);
      }
    </script>
  </body>
</html>
